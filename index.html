<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
<meta charset="utf-8">
<title>D3: Force layout</title>
<script type="text/javascript" src="./lib/d3.v5.min.js"></script>
</head>
<body>
<div id="network"></div>
<button id="changeColorButton">change the color by category</button>
<div id = "choropleth"></div>
<script type="text/javascript">
//Width and height
var w = 1000;
var h = 800;
d3.dsv(",", "data_all.csv", function(d) {
	return {
		start_date: new Date(d.start_date),
		end_date: new Date(d.end_date),
		source: d.source,
		target: d.target,
		value: +d.default,
		category: d.category
	}
}).then(function(data) {
	var network_exist = false;

	var nodes = [];
	var edges = [];
	var start_date_list = [];
	var end_date_list = [];
	// 检查 SVG 是否存在
	//var svgExists = !!d3.select("#network").select("svg").node();

	// 获取按钮元素
	var button = d3.select("#changeColorButton");
	button.style("display", "none");
/**
	if (network_exist) {
		// 如果 SVG 存在，显示按钮
		button.style("display", null);
	} else {
		// 如果 SVG 不存在，隐藏按钮
		button.style("display", "none");
	}
	**/
	data.forEach(function(d) {
		if (!nodes.find(node => node.name === d.source)) {
			nodes.push({
				name: d.source,
				default: d.value,
				category: d.category
			});
		}
		if (!nodes.find(node => node.name === d.target)) {
			nodes.push({
				name: d.target,
				default: d.value,
				category: d.category
			});
		}
		start_date_list.push(d.start_date);
		end_date_list.push(d.end_date);

		// 根据节点名称找到对应的索引，构建边
		var sourceIndex = nodes.findIndex(node => node.name === d.source);
		var targetIndex = nodes.findIndex(node => node.name === d.target);
		edges.push({
			source: sourceIndex,
			target: targetIndex
		});
	});
	var dataset = {
		nodes: nodes,
		edges: edges
	};

//整合成function
function processData(data, date) {
    var nodes = [];
    var edges = [];
    var start_date_list = [];
    var end_date_list = [];

    data.forEach(function(d) {
        var startDate = new Date(d.start_date);
        var endDate = new Date(d.end_date);
        var filterDate = new Date(date);

        if (startDate < filterDate && endDate > filterDate) {
            if (!nodes.find(node => node.name === d.source)) {
                nodes.push({
                    name: d.source,
					default: d.value,
					category: d.category
                });
            }
            if (!nodes.find(node => node.name === d.target)) {
                nodes.push({
                    name: d.target,
					default: d.value,
					category: d.category
                });
            }
            start_date_list.push(d.start_date);
            end_date_list.push(d.end_date);

            var sourceIndex = nodes.findIndex(node => node.name === d.source);
            var targetIndex = nodes.findIndex(node => node.name === d.target);
            edges.push({
                source: sourceIndex,
                target: targetIndex
            });
        }
    });

    var dataset = {
        nodes: nodes,
        edges: edges
    };

    return dataset;
}
var dateFilter = "2024-03-15"; // 例如，过滤条件为2024年3月15日
var processedData = processData(data, dateFilter);

	var colors = d3.schemeCategory10;
	//var colors = d3.scaleOrdinal(d3.schemeCategory10);
	console.log("------------------------输出颜色---------------------------");
	d3.schemeCategory10.forEach(function(color, i) {
		console.log('color index', i, ':', color);
	});
	
	var default_color = ['green','red'];
	var div0 = d3.select("#network")
		.append("div")
		.style("width", "100%")
		.style("height", "30px")
		.style("background-color", "yellow")
		.style("text-align", "center")
		.style("font-weight", "bold")
		.text("Loan Network Vis");
	//添加 TIME Line
	var div = d3.select("#network")
		.append("div")
		.attr("id", "t");

	div.append("p")
		.attr("id", "t-Year")
		.style("width", "100%")
		.style("height", "30px")
		.style("text-align", "center")
		.style("font-weight", "bold")
		.text("Time Slider")
		.on("click", deleteNetwork);

	var sliderDiv = div.append("div")
		.attr("id", "slider-year")

	var slider = sliderDiv.append("input")

		.attr("type", "range")
		.attr("min", d3.min(start_date_list).getTime())
		.attr("max", d3.max(start_date_list).getTime())
		.attr("value", d3.min(start_date_list).getTime())
		.attr("id", "myRange")
		.attr("step", 20 * 60 * 60 * 1000)
		.style("width", "80%") // 设置滑块的宽度
		.style("height", "30px"); // 设置步长为一天



	var numTicks = 5; // 刻度数量
	var tickValues = d3.range(d3.min(start_date_list).getTime(), d3.max(start_date_list).getTime(), (d3.max(
		start_date_list).getTime() - d3.min(start_date_list).getTime()) / numTicks);
	var formatTime = d3.timeFormat("%Y-%m-%d");
	// 创建用于显示当前时间的 div 元素
	var currentTimeDiv = sliderDiv.append("div")
		.attr("id", "time_notion")
		.style("position", "absolute")
		.style("top", "150px") // 调整显示位置
		//.style("left", "10%") // 调整显示位置
		.style("font-size", "14px"); // 调整字体大小

	// 更新当前时间显示
	function updateCurrentTime(currentTime) {
		currentTimeDiv.text("当前时间：" + formatTime(currentTime));
	}

	// 初始化时显示起始时间
	updateCurrentTime(new Date(d3.min(start_date_list).getTime()));
	slider.on("input", function() {
		var dateValue = new Date(parseInt(this.value)).toDateString(); // 将时间戳转换为日期字符串
		updateCurrentTime(new Date(parseInt(this.value)));
		time_now = new Date(parseInt(this.value));
		dataset_now = processData(data,time_now);
		createNetwork(dataset_now,dateValue)
	});

	sliderDiv.selectAll(".tick")
		.data(tickValues)
		.enter().append("span") // 使用 <span> 元素作为刻度的显示元素
		.classed("tick", true)
		.style("position", "absolute")
		.style("left", function(d) {
			return ((d - d3.min(start_date_list).getTime()) / (d3.max(start_date_list).getTime() - d3
				.min(start_date_list).getTime()) * 77) + "%"; // 根据日期值设置刻度位置
		})
		.style("top", "130px")
		.style("font-size", "8px") // 调整刻度文字的字体大小
		 // .style("transform", "translateX(10px)")// 使每个元素向右边移动100像素
		.text(function(d) {

			return formatTime(new Date(d)); // 显示日期
		});


	sliderDiv.selectAll(".tick-line")
		.attr("id", "Time_slider_tick")
		.data(tickValues)
		.enter().append("div")
		.classed("tick-line", true)
		.style("position", "absolute")
		.style("left", function(d) {
			//updateCurrentTime(new Date(d))
			return ((d - d3.min(start_date_list).getTime()) / (d3.max(start_date_list).getTime() - d3
				.min(start_date_list).getTime()) * 78.9) + "%"; // 根据日期值设置刻度线位置
		})
		.style("top", "120px")
		.style("width", "1px") // 设置刻度线宽度
		.style("height", "10px") // 设置刻度线高度
		.style("transform", "translateX(12px)")// 使每个元素向右边移动100像素
		.style("background-color", "black"); // 设置刻度线颜色

    function deleteNetwork(){
	// 判断是否已经存在 SVG 元素，如果存在则先移除
		network_exist = false;
        d3.select("#network").selectAll("svg").remove();
}
function createNetwork(dataset,dateValue){
	var default_graph = true;
	button.style("display", null);
	d3.select("#changeColorButton").on("click", function() {
    // 检查是否存在 SVG 元素
    //var svgExists = !!d3.select("#network").select("svg").node();

    // 如果存在 SVG 元素，改变节点颜色
    if (default_graph) {//换成行业颜色
        d3.select("#network").selectAll("circle")
            .transition()      // 添加过渡效果
            .duration(500)     // 过渡持续时间
			/**
            .style("fill", function(d) {
                if(d.category == "daily consumption")
					return colors(0);
				else if(d.category == "energy")
					return colors(1);
				else if(d.category == "financial")
					return colors(2);
				else if(d.category == "it")
					return colors(3);
				else if(d.category == "materials")
					return colors(4);
				else if(d.category == "medical_insurance")
					return colors(5);
				else if(d.category == "optional")
					return colors(6);
				else if(d.category == "public")
					return colors(7);
				else if(d.category == "real estate")
					return colors(8);
				//if(d.category == "it")
					//return colors(9);
				else if(d.category == "industry")
					return colors(9);
				else
					return "black";  // 改变颜色，替换为你想要的颜色
            });
			**/
			.style("fill", function(d) {
                if(d.category == "daily consumption")
					return '#1f77b4';//深蓝色
				else if(d.category == "energy")
					return '#ff7f0e';//橙色
				else if(d.category == "financial")
					return '#2ca02c';//绿色
				else if(d.category == "it")
					return '#d62728';//红色
				else if(d.category == "materials")
					return '#9467bd';//紫色
				else if(d.category == "medical_insurance")
					return '#8c564b';//棕色
				else if(d.category == "optional")
					return '#e377c2';//粉红色
				else if(d.category == "public")
					return '#7f7f7f';//灰色
				else if(d.category == "real estate")
					return '#bcbd22';//橄榄绿色
				//if(d.category == "it")
					//return colors(9);
				else if(d.category == "industry")
					return '#17becf';//青色
				else
					return "black";  // 改变颜色，替换为你想要的颜色
            });
		default_graph = false;
		document.getElementById("changeColorButton").innerHTML = "change the color by default";
	}
	else{
		d3.select("#network").selectAll("circle")
            .transition()      // 添加过渡效果
            .duration(500)     // 过渡持续时间
            .style("fill", function(d) {
			return default_color[d.default];
			});
		default_graph = true;
		document.getElementById("changeColorButton").innerHTML = "change the color by category";	
	}

    //}
});
	network_exist = true;
	//行业颜色
	var colors = d3.scaleOrdinal(d3.schemeCategory10);
	
	// 判断是否已经存在 SVG 元素，如果存在则先移除
    d3.select("#network").selectAll("svg").remove();
	//Create SVG element
	var svg = d3.select("#network")
		.append("svg")
		.attr("width", "100%")
		.attr("height", h)
		;


	var container = svg.append("g");
	// 创建缩放行为
	var zoom = d3.zoom()
		.scaleExtent([0.5, 4]) // 设置缩放范围
		.on("zoom", function() {
			container.attr("transform", d3.event.transform);
			// 更新缩放状态
			isZoomed = d3.event.transform.k !== 1;
		});
		// 应用缩放行为到 SVG 元素

	svg.call(zoom);
	//Initialize a simple force layout, using the nodes and edges in dataset
	var boundaryMargin = 5; // 边界边距
	var force = d3.forceSimulation(dataset.nodes)
		.force("charge", d3.forceManyBody().strength(-2))
		.force("link", d3.forceLink(dataset.edges).strength(0.2).distance(30))
		.force("center", d3.forceCenter().x(2600 / 2).y(h / 2))
		.on("tick", function() {
			nodes.forEach(function(d) {
				d.x = Math.max(boundaryMargin, Math.min(1000 - boundaryMargin, d
				.x)); // 限制节点在水平方向的移动范围
				d.y = Math.max(boundaryMargin, Math.min(1000 - boundaryMargin, d
				.y)); // 限制节点在垂直方向的移动范围
			})
		});
	container//arrow
		.append("svg:defs")
		.append("svg:marker")
		.attr("id", "triangle")
		.attr("viewBox", "0 -5 10 10")
		.attr("refX", 15)
		.attr("refY", -1.5)
		.attr("markerWidth", 6)
		.attr("markerHeight", 6)
		.attr("orient", "auto")
		.style("fill", "gray")
		.append("path")
    	.attr("d", "M0,-5L10,0L0,5");
		/**
//添加legend
	var legend_x = 1200;
	var legend_text = ['2015','2016','2017','2018','2019'];

    var legend = container.append("g")
        .attr("class", "legend")
        .attr("id","legend")
        .attr("height", 100)
        .attr("width", 900) 

    legend.selectAll('rect').data(legend_text).enter()
        .append("rect")
        .attr("x", legend_x+ 10)
        .attr("y", function(d, i){ return i*25;})
        .attr("width", 30)
        .attr("height", 20)
        .style("fill", function(d,i) { 
            var color = colors[i];
            return color;
        })
                  
    legend.selectAll('text')
        .data(legend_text)
        .enter()
        .append("text")
        .style("font-size", "15px")
        .attr("x", legend_x + 45)
        .attr("y", function(d, i){ return i*25 + 15;})
        .text(function(d) {
            var text = d;
            return text;
    });
	**/
//
	//Create edges as lines
	var edges = container.selectAll("line")
		.data(dataset.edges)
		.enter()
		.append("line")
		.style("stroke", "#ccc")
		.attr('marker-end', 'url(#triangle)')
		.style("stroke-width", 1);
	
	//Create nodes as circles]
	var nodes = container.selectAll("circle")
		.data(dataset.nodes)
		.enter()
		.append("circle")
		.attr("r", 5)

		.style("fill", function(d) {
			return default_color[d.default];
		})

		.call(d3.drag() //Define what to do on drag events
			.on("start", dragStarted)
			.on("drag", dragging)
			.on("end", dragEnded))
		// .on("dblclick", handleDoubleClick)
		/**
        .on("click", function(d) {
            var year = new Date(dateValue).getFullYear();
            var category = d.category;
            initMap(category, year);
        })
		**/
		.on("dblclick", handleDoubleClick);;

	//Add a simple tooltip
	nodes.append("title")
		.text(function(d) {
			var text = "公司名称"+d.name+"公司行业"+d.category;
			return text;
		});

	//Every time the simulation "ticks", this will be called
	force.on("tick", function() {

		edges.attr("x1", function(d) {
				return d.source.x;
			})
			.attr("y1", function(d) {
				return d.source.y;
			})
			.attr("x2", function(d) {
				return d.target.x;
			})
			.attr("y2", function(d) {
				return d.target.y;
			});

		nodes.attr("cx", function(d) {
				return d.x;
			})
			.attr("cy", function(d) {
				return d.y;
			});

	});

	//Define drag event functions
	function dragStarted(d) {
		if (!d3.event.active) force.alphaTarget(0.003).restart();
		d.fx = d.x;
		d.fy = d.y;
	}

	function dragging(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
		d.fixed = true;
		/**
		if (d.fx >= w - 10) {
			d.fx = w - 10;
		}
		if (d.fx <= 10) {
			d.fx = 10;
		}
		if (d.fy <= 10) {
			d.fy = 10;
		}
		if (d.fy >= h - 10) {
			d.fy = h - 10;
		}
		**/
		d3.select(this)
			.transition()
			.duration(500)
			.attr("r", 15);
	}

	function dragEnded(d) {
		if (!d3.event.active) force.alphaTarget(0);
		if (d.fixed == true) {
			d.fx = d.x;
			d.fy = d.y;
			//节点半径变大

			d3.select(this)
				.transition()
				.duration(700)
				.attr("r", 40);
			//d3.select(this).style("fill", "black");
			var year = new Date(dateValue).getFullYear();
            var category = d.category;
            initMap(category, year);

		} else {
			d.fx = null;
			d.fy = null;
		}
	}

	// 定义处理双击事件的函数
	function handleDoubleClick(d) {
		d.fx = null;
		d.fy = null;
		d.fixed = false; // 取消固定状态
		//选中的点半径变大
		d3.select(this)
			.transition()
			.duration(500)
			.attr("r", 5);
		//d3.select(this).style("fill", "red");
		// 取消节点的标记
		//双击后，选中的节点恢复
		d3.select(this).classed("pinned", false);
		d3.select("#choropleth").selectAll("svg").remove();

	}
}
})



function initMap(selectedCategory, selectedYear) {

    d3.select("#choropleth").selectAll("svg").remove();
// enter code to define margin and dimensions for svg
    margins = ({top: 22, right: 32, bottom: 22, left: 32})
    var svgWidth = 1100;
    var svgHeight = 500;

// enter code to create svg
    var svg = d3.select("#choropleth").append("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight)
		.style("transform", "translate(" + svgWidth / 2 + "px," + 0 + "px)");
    var countries = svg.append("g").attr("id", "countries");
    var legends = svg.append("g").attr("id", "legend");

// enter code to create color scale
    var colorRange = ["#BDD7EE", "#6091BB", "#5078A0", "#2A5783"];
    var colorScale = d3.scaleQuantile().range(colorRange);

// enter code to define tooltip
    var tp = d3.select("#choropleth")
        .append("div")
        .attr("id", "tooltip")
        .attr("class", "tooltip");

    var projection = d3.geoMercator()
        .center([105, 38])
        .scale(600)
        .translate([500, svgHeight / 2]);

    var path = d3.geoPath().projection(projection);

    Promise.all([
        d3.csv("data.csv"),
        d3.json("china.json")
    ]).then(
        function (files) {
            var data2022 = files[0];
            var china = files[1];
            china.features.forEach(function (feature) {
                feature.properties.data = {};
            });

            data2022.forEach(function (record) {
                var provinceName = record.Province;
                var category = record.Category;
                var feature = china.features.find(function (f) {
                    return f.properties.name === provinceName;
                });

            });

            var filteredData = data2022.filter(function (d) {
            console.log(d["Values in " + selectedYear + " (100 million yuan)"] )
                return d.Category.toLowerCase() === selectedCategory.toLowerCase()
                    && d["Values in " + selectedYear + " (100 million yuan)"]  !== undefined;
            });
            console.log("######"+filteredData)
            console.log(filteredData)

            var values = filteredData.map(function (d) {
                return +d["Values in " + selectedYear + " (100 million yuan)"];
            });
            colorScale.domain([d3.min(values), d3.max(values)]);

            var paths = countries.selectAll("path")
                .data(china.features);

            paths.exit().remove();

            paths.enter()
                .append("path")
                .merge(paths)
                .attr("d", path)
                .attr("fill", function (d) {
                    var provinceData = filteredData.find(function (p) {
                        return p.Province === d.properties.name;
                    });
                    return provinceData ? colorScale(+provinceData["Values in " + selectedYear + " (100 million yuan)"]) : "grey";
                })
                .on("mouseover", function (d) {
                    console.log("******"+d);
                    console.log(d);
                    var provinceData = filteredData.find(function (p) {
                        return p.Province === d.properties.name;
                    });
                    if (provinceData) {
                        tp.html("Province: " + provinceData.Province + "<br/>" +
                            "Values in " + selectedYear + " (100 million yuan): " + provinceData["Values in " + selectedYear + " (100 million yuan)"]
                            + "<br/>" + "Category: "+ selectedCategory)
                            .style("opacity", 1)
							.style("left", (d3.event.pageX + 10) + "px") // 设置提示框的左边距为鼠标位置的横坐标加10px
          					.style("top", (d3.event.pageY + 10) + "px")
							.style("color",'red');  // 设置提示框的顶部距离为鼠标位置的纵坐标加10px;
                    }
                })
                .on("mouseout", function (d) {
                    tp.style("opacity", 0); // Hide the tooltip when the mouse moves away
                });

            legends.selectAll("*").remove();

            for (var i = 0; i < colorRange.length; i++) {
                legends.append("rect")
                    .attr('x', 865)
                    .attr('y', 50 + 20 * i)
                    .attr('height', 15)
                    .attr('width', 15)
                    .attr("fill", colorRange[i]);
            }

            var quantiles = colorScale.quantiles();

            legends.append("text")
                .attr("id", "txt1")
                .attr("x", 900)
                .attr("y", 63)
                .style("font-size", "15px")
                .text("≤ " + quantiles[0].toFixed(2));

            quantiles.forEach(function (q, i) {
                if (i < colorRange.length - 2) {
                    legends.append("text")
                        .attr("id", "txt" + (i + 2))
                        .attr("x", 900)
                        .attr("y", 83 + 20 * i)
                        .style("font-size", "15px")
                        .text(quantiles[i].toFixed(2) + " to " + quantiles[i + 1].toFixed(2));
                }
            });

            legends.append("text")
                .attr("id", "txt" + (colorRange.length))
                .attr("x", 900)
                .attr("y", 63 + 20 * (colorRange.length - 1))
                .style("font-size", "15px")
                .text("> " + quantiles[quantiles.length - 1].toFixed(2));
        }
    );
}


// define any other global variables
</script>
</body>
<style>

    #network, #choropleth {
        width: 100%;
        margin: auto;
		justify-content: center; 
    	align-items: center;
    }
	.tooltip{
		position:absolute;
	}

</style>
</html>
